---
import BaseLayout from '../layouts/BaseLayout.astro';
import CodeBlock from '../components/CodeBlock.astro';
import emhassScriptYaml from '../includes/emhass_script.yaml?raw';

const automationYaml = `alias: "Generate EMHASS energy plan"
description: "Automatically generate EMHASS energy plan when prices change"
triggers:
  - trigger: state
    entity_id:
      - sensor.home_general_price
      - sensor.home_feed_in_price
    enabled: true
  - trigger: time_pattern
    minutes: "*"
    hours: "*"
conditions: []
actions:
  - action: script.generate_emhass_energy_plan_mpc
    metadata: {}
    data: {}
mode: single`;
---

<BaseLayout title="Running EMHASS">
  <h1>Running EMHASS</h1>

  <p>To run EMHASS, we want to execute the rest commands we setup earlier with all the parameters they need. In this guide we
  will use scripts.</p>

  <p>You will also need to manually enable these disabled Sigenergy Plant sensors in order for the script to function:</p>

  <ul>
    <li><code>sensor.sigen_plant_rated_energy_capacity</code></li>
    <li><code>sensor.sigen_plant_ess_rated_charging_power</code></li>
    <li><code>sensor.sigen_plant_ess_rated_discharging_power</code></li>
    <li><code>sensor.sigen_plant_max_active_power</code></li>
  </ul>

  <p>Solcast by default only enables today and tomorrow solar forecast sensors, meaning at 11pm you'll only get 25 hours of
  forecasting. You will need to enable the solcast day 3 forecast sensor to always provide 2 full days of solar
  forecasting (and if you want longer horizons, you can enable up to 7 days and add them to the forecasts list within the
  script).</p>

  <ul>
    <li><code>sensor.solcast_pv_forecast_forecast_day_3</code></li>
  </ul>

  <p>Next, create a new script from scratch (under Settings → Automations & Scenes → Scripts), switch to YAML mode and add
  the content below.</p>

  <p>The critical variables to configure are at the very top.</p>

  <ol>
    <li><code>costfun</code> — this can be either <code>profit</code>, <code>cost</code> or <code>self-consumption</code>, which either maximize profit, minimize cost or
       maximize self-consumption (selling any excess).
       <ul>
         <li>UPDATE: There is currently an <a href="https://github.com/davidusb-geek/emhass/issues/559">open issue</a> within EMHASS
           preventing this parameter from working correctly. For now, you will need to set it via the EMHASS Config editor.</li>
       </ul>
    </li>
    <li><code>maximum_power_from_grid</code> — this is the maximum power you can draw from the grid (e.g. when charging your batteries
       from the grid).</li>
    <li><code>maximum_power_to_grid</code> — this is the maximum power you can feed into the grid (e.g. when exporting solar, or
       discharging batteries).</li>
    <li><code>battery_minimum_percent</code> — what percentage (0-100) of your battery you always want to keep as a minimum (e.g. for
       blackout protection).</li>
  </ol>

  <CodeBlock code={emhassScriptYaml} lang="yaml" />

  <p>If you run this script, EMHASS will produce a plan for the day. You should be able to manually run the script and check
  the output in the EMHASS webview. We will also be adding our own output dashboard shortly.</p>

  <p>You'll want to be running this script regularly as forecasts change throughout the day, so the next step is to setup a
  new automation:</p>

  <CodeBlock code={automationYaml} lang="yaml" />

  <p>This will run every time the prices change and every minute to account for live solar / usage power changes.</p>

  <p>Note: On my Intel NUC Home Assistant server, this script takes a couple of seconds to run. If you are running lower-end
  hardware, you may want to either increase the optimization time step or reduce the running frequency.</p>

  <h2 id="up-next">Up Next</h2>

  <p>→ <a href="/dashboard">Dashboard Setup</a></p>
</BaseLayout>

