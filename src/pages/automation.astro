---
import BaseLayout from '../layouts/BaseLayout.astro';
import CodeBlock from '../components/CodeBlock.astro';
import batteryAutomationYaml from '../includes/battery_automation.yaml?raw';
import curtailmentYaml from '../includes/curtailment.yaml?raw';
---

<BaseLayout title="Automation & Scheduling">
  <h1>Automated Battery Control</h1>

  <p>EMHASS by itself just creates the energy plan, but it won't actually know how to execute upon it. In order to execute
  the plan, we will need an automation.</p>

  <p>Note: Make sure the Sigenergy integration is no longer in Read-Only Mode, as we will now be changing values
  automatically! You will also have to turn <code>switch.sigen_plant_remote_ems_controled_by_home_assistant</code> on (Important:
  This will disable Amber SmartShift, which as of this writing you cannot currently turn back on without contacting
  Amber).</p>

  <p>This automation switches the Sigenergy battery system between 4 operating modes depending on the energy plan:</p>

  <ol>
    <li>Maximum Self Consumption</li>
    <li>Command Discharging (PV First)</li>
    <li>Command Charging (PV First)</li>
    <li>Standby</li>
  </ol>

  <p>Using just these four modes and modulating various charge and discharge limits, we can achieve a great deal!</p>

  <p>You will also need to manually enable these disabled Sigenergy Plant sensors in order for the script to function:</p>

  <ul>
    <li><code>select.sigen_plant_remote_ems_control_mode</code></li>
    <li><code>number.sigen_plant_ess_max_charging_limit</code></li>
    <li><code>number.sigen_plant_ess_max_discharging_limit</code></li>
    <li><code>number.sigen_plant_pcs_import_limitation</code></li>
    <li><code>number.sigen_plant_grid_export_limitation</code></li>
    <li><code>number.sigen_plant_pv_max_power_limit</code></li>
  </ul>

  <CodeBlock code={batteryAutomationYaml} lang="yaml" />

  <h3>Curtailment</h3>

  <p>You will also want an automation to automatically handle negative prices. This automation will prevent selling PV at a
  negative feed-in price and will also prevent using solar when there is a negative general price (as you'll make more
  money drawing from the grid instead).</p>

  <CodeBlock code={curtailmentYaml} lang="yaml" />

  <h2 id="up-next">Up Next</h2>

  <p>â†’ <a href="/conclusion">Conclusion</a></p>
</BaseLayout>

